<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="go-zero gin jaeger trace"><meta name="keywords" content="golang,jaeger,go-zero"><meta name="author" content="ronething"><meta name="copyright" content="ronething"><title>go-zero gin jaeger trace | ronething's blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="alternate" href="/atom.xml" title="ronething's blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00"><span class="toc-text">0x00</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01"><span class="toc-text">0x01</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02"><span class="toc-text">0x02</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://blog-1253523830.cosgz.myqcloud.com/assets/img/20190516230757.png"></div><div class="author-info__name text-center">ronething</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/ronething">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">65</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">24</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-1253523830.cosgz.myqcloud.com/assets/img/20190608153614.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">ronething's blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/sources">Sources</a></span></div><div id="post-info"><div id="post-title">go-zero gin jaeger trace</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-06-28</time><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1.5k</span><span class="post-meta__separator">|</span><span>Reading time: 6 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>最近玩玩链路追踪</p>
<a id="more"></a>
<h2 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h2><ul>
<li>什么是链路追踪？</li>
</ul>
<blockquote>
<p>链路追踪 Tracing Analysis 为分布式应用的开发者提供了完整的调用链路还原、调用请求量统计、链路拓扑、应用依赖分析等工具，可以帮助开发者快速分析和诊断分布式应用架构下的性能瓶颈，提高微服务时代下的开发诊断效率。</p>
</blockquote>
<p>通俗一点讲就是多个服务之间调用可以串成一条链，例如 A 调用 B，B 调用 C</p>
<ul>
<li>为什么需要链路追踪？</li>
</ul>
<blockquote>
<p>为了应对各种复杂的业务，开发工程师开始采用敏捷开发、持续集成等开发方式。系统架构也从单机大型软件演化成微服务架构。微服务构建在不同的软件集上，这些软件模块可能是由不同团队开发的，可能使用不同的编程语言来实现，还可能发布在多台服务器上。因此，如果一个服务出现问题，可能导致几十个应用都出现服务异常。</p>
</blockquote>
<p>通俗一点讲还是多个服务之间调用，假设某个环节出现了问题，可能要查询哪个服务出现问题，一个一个排查成本过高也不科学，还有就是可以通过链路追踪查询出各个服务在一条链路中的请求响应耗时，从而进行一些针对性的优化等。</p>
<ul>
<li>什么是调用链(Trace)？</li>
</ul>
<blockquote>
<p>在广义上，一个调用链代表一个事务或者流程在（分布式）系统中的执行过程。在 OpenTracing 标准中，调用链是多个 Span 组成的一个有向无环图（Directed Acyclic Graph，简称DAG），每一个 Span 代表调用链中被命名并计时的连续性执行片段。</p>
</blockquote>
<p>可以大概理解为整条链路只有一个 traceId，但是可能会有多个 span，服务间的调用会产生对应的 span。</p>
<ul>
<li>OpenTelemetry</li>
</ul>
<blockquote>
<p>OpenTelemetry, also known as OTel for short, is a vendor-neutral open-source <a href="https://opentelemetry.io/docs/concepts/observability-primer/#what-is-observability" target="_blank" rel="noopener">Observability</a> framework for instrumenting, generating, collecting, and exporting telemetry data such as <a href="https://opentelemetry.io/docs/concepts/observability-primer/#distributed-traces" target="_blank" rel="noopener">traces</a>, <a href="https://opentelemetry.io/docs/concepts/observability-primer/#reliability--metrics" target="_blank" rel="noopener">metrics</a>, <a href="https://opentelemetry.io/docs/concepts/observability-primer/#logs" target="_blank" rel="noopener">logs</a>. As an industry-standard it is <a href="https://opentelemetry.io/vendors" target="_blank" rel="noopener">natively supported by a number of vendors</a>.</p>
</blockquote>
<p>otel 作为一个可观测性框架，主要可用于 traces(链路追踪)，metrics(指标)，logs(日志) 等数据的检测，生成，采集和导出。</p>
<p>概念性的东西可能比较多， 后面会贴上参考资料</p>
<p><a href="https://opentelemetry.io/" target="_blank" rel="noopener">opentelemetry 可观测性框架</a></p>
<p><a href="https://stanxing.hedwig.pub/i/liao-liao-fen-bu-shi-lian-lu-zhui-zong-he-ke-guan-cha-xing" target="_blank" rel="noopener">聊聊分布式链路追踪和可观察性</a></p>
<p><a href="https://help.aliyun.com/document_detail/196637.html" target="_blank" rel="noopener">aliyun tracing analysis</a></p>
<hr>
<ul>
<li>实战部分</li>
</ul>
<p>1、<a href="https://www.jaegertracing.io/" target="_blank" rel="noopener">Jaeger</a>: open source, end-to-end distributed tracing</p>
<p>为什么不使用 zipkin? 通常来讲 java 系 zipkin 用的多，go 项目一般用 jaeger</p>
<p>测试使用，直接 all-in-one</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name jaeger \</span><br><span class="line">  -e COLLECTOR_ZIPKIN_HOST_PORT=:<span class="number">9411</span> \</span><br><span class="line">  -e COLLECTOR_OTLP_ENABLED=<span class="literal">true</span> \</span><br><span class="line">  -p <span class="number">6831</span>:<span class="number">6831</span>/udp \</span><br><span class="line">  -p <span class="number">6832</span>:<span class="number">6832</span>/udp \</span><br><span class="line">  -p <span class="number">5778</span>:<span class="number">5778</span> \</span><br><span class="line">  -p <span class="number">16686</span>:<span class="number">16686</span> \</span><br><span class="line">  -p <span class="number">4317</span>:<span class="number">4317</span> \</span><br><span class="line">  -p <span class="number">4318</span>:<span class="number">4318</span> \</span><br><span class="line">  -p <span class="number">14250</span>:<span class="number">14250</span> \</span><br><span class="line">  -p <span class="number">14268</span>:<span class="number">14268</span> \</span><br><span class="line">  -p <span class="number">14269</span>:<span class="number">14269</span> \</span><br><span class="line">  -p <span class="number">9411</span>:<span class="number">9411</span> \</span><br><span class="line">  jaegertracing/all-in-one:<span class="number">1.35</span></span><br></pre></td></tr></table></figure>
<p>2、trace 接入</p>
<p>因为项目使用了 go-zero，go-zero 又直接集成了 opentelemetry，pr 见 <a href="https://github.com/zeromicro/go-zero/pull/1111" target="_blank" rel="noopener">feat: opentelemetry integration, removed self designed tracing</a></p>
<p>所以理论上只需要进行相关配置即可使用链路追踪</p>
<p>不过凡事都有但是，目前只有 rpc 服务使用了 go-zero 的 zrpc，http web framework 部分使用了 gin，没有使用 go-zero 的 httpx</p>
<p>所以需要手动编写对应的 gin middleware 进行 trace ctx 的生成和 response header 的注入</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">	<span class="string">"github.com/zeromicro/go-zero/core/trace"</span></span><br><span class="line">	<span class="string">"go.opentelemetry.io/otel"</span></span><br><span class="line">	<span class="string">"go.opentelemetry.io/otel/propagation"</span></span><br><span class="line">	semconv <span class="string">"go.opentelemetry.io/otel/semconv/v1.4.0"</span></span><br><span class="line">	oteltrace <span class="string">"go.opentelemetry.io/otel/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// TracingHandler return a middleware that process the opentelemetry.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TracingHandler</span><span class="params">(serviceName <span class="keyword">string</span>)</span> <span class="title">gin</span>.<span class="title">HandlerFunc</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ginCtx *gin.Context)</span></span> &#123;</span><br><span class="line">		propagator := otel.GetTextMapPropagator()</span><br><span class="line">		tracer := otel.Tracer(trace.TraceName) <span class="comment">// 影响的是 trace 中的 otel.library.name 字段</span></span><br><span class="line"></span><br><span class="line">		ctx := propagator.Extract(ginCtx.Request.Context(), propagation.HeaderCarrier(ginCtx.Request.Header))</span><br><span class="line">		spanName := ginCtx.Request.URL.Path</span><br><span class="line">		<span class="comment">//logx.Info("spanName is", spanName)</span></span><br><span class="line">		spanCtx, span := tracer.Start(</span><br><span class="line">			ctx,</span><br><span class="line">			spanName,</span><br><span class="line">			oteltrace.WithSpanKind(oteltrace.SpanKindServer),</span><br><span class="line">			oteltrace.WithAttributes(semconv.HTTPServerAttributesFromHTTPRequest(</span><br><span class="line">				serviceName, spanName, ginCtx.Request)...),</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">defer</span> span.End()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// convenient for tracking error messages 注入返回 response key: Traceparent</span></span><br><span class="line">		propagator.Inject(spanCtx, propagation.HeaderCarrier(ginCtx.Writer.Header()))</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 注入 context</span></span><br><span class="line">		ginCtx.Request = ginCtx.Request.WithContext(spanCtx)</span><br><span class="line"></span><br><span class="line">		ginCtx.Next()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里其实有一个点，<code>ginCtx.Request = ginCtx.Request.WithContext(spanCtx)</code> 通过此方式才可以进行对应 context 的注入</p>
<p>gin.Context 是一个 struct 而不是 context.Context 所以导致有一些问题解决比较麻烦。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">服务端配置文件</span></span><br><span class="line"><span class="attr">Telemetry:</span></span><br><span class="line"><span class="attr">  Name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">  Endpoint:</span> <span class="attr">http://localhost:14268/api/traces</span></span><br><span class="line"><span class="attr">  Sampler:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">  Batcher:</span> <span class="string">jaeger</span></span><br></pre></td></tr></table></figure>
<p>3、效果</p>
<p><img src="https://blog-1253523830.cosgz.myqcloud.com/assets/img/202207031536610.png" alt></p>
<ul>
<li>顺便讲讲 go-zero 升级</li>
</ul>
<p>以上讲的示例是我个人的项目，工作上的项目因为之前 fork 并进行了修改，所以需要手动 merge 并重新打 tag 发布</p>
<p>还有一个比较麻烦的问题是 go module 名称的替换，原先 go-zero <code>github.com/tal-tech/go-zero</code> 后来变成了 <code>github.com/zeromicro/go-zero</code> ，官方 goctl 有提供相应 migrate 命令，不过我并没有进行使用，全局匹配 go 文件并进行相应替换。</p>
<p>还遇到一个有趣的问题，可见此 <a href="https://github.com/zeromicro/go-zero/issues/1344" target="_blank" rel="noopener">issue</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:702:10: invalid operation: logr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:721:10: invalid operation: logr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:739:10: invalid operation: logr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:760:10: invalid operation: logr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:779:11: invalid operation: loggr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:791:11: invalid operation: loggr != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:915:9: invalid operation: <span class="built_in">log</span> != nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:1277:18: invalid operation: logging.logr == nil (mismatched types logr.Logger and nil)</span><br><span class="line">........\pkg\mod\k8s.io\klog\v2@v2.4.0\klog.go:1278:21: cannot use nil as <span class="built_in">type</span> logr.Logger <span class="keyword">in</span> field value</span><br></pre></td></tr></table></figure>
<p>解决方案也很简单，直接升级即可 <code>go get -v k8s.io/klog/v2</code></p>
<p>接下来需要更新 goctl，不然生成的代码 import 的还是 <code>tal-tech</code> 的 module name</p>
<p>PS: 暂时没有将 demo 整理出来，后续考虑整理并开源一下，目前网上暂时没有看到 gin 结合 go-zero 上报 trace 相关。</p>
<h2 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h2><p>半年就要过去了，那么加油。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ronething</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://blog.ronething.cn/20220628-go-zero-trace-gin.html">https://blog.ronething.cn/20220628-go-zero-trace-gin.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/golang/">golang</a><a class="post-meta__tags" href="/tags/jaeger/">jaeger</a><a class="post-meta__tags" href="/tags/go-zero/">go-zero</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/20220629-zhengzaitv-go.html"><i class="fa fa-chevron-left">  </i><span>zhengzaitv-go release</span></a></div><div class="next-post pull-right"><a href="/20220606-functioncompute.html"><span>function compute</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://blog-1253523830.cosgz.myqcloud.com/assets/img/20190608153614.png)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By ronething</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>